<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>New Peace Studio</title>
<style>
body { font-family: monospace; background: #1e1e1e; color: #f5f5f5; margin:0; }
#editor { width: 100%; height: 200px; background:#2e2e2e; color:#f5f5f5; padding:5px; }
#output { width: 100%; height:200px; background:#111; color:#0f0; padding:5px; overflow:auto; }
button, select { margin: 5px; }
</style>
</head>
<body>

<h2>New Peace Studio</h2>

<select id="languageSelect">
  <option value="python">Python</option>
  <option value="js">JavaScript</option>
  <option value="html">HTML</option>
  <option value="c">C (WASM)</option>
</select>

<button onclick="createProject()">Новый проект</button>
<button onclick="saveCurrentProject()">Сохранить</button>
<button onclick="runCode()">▶ Запустить</button>

<div id="editor" contenteditable="true">print("Привет, Эльдар!")</div>
<div id="output"></div>
<div id="pluginList"></div>

<script type="module">
import { loadPyodide } from './pyodide.js';

let pyodide;
let currentLang = "python";
let currentProject = null;

// Загрузка Pyodide
async function main() {
  log("⏳ Загружается Python...");
  try {
    pyodide = await loadPyodide({ indexURL: './' });
    log("✅ Python готов!");
  } catch(e) {
    log("❌ Ошибка загрузки Pyodide: " + e);
  }
  loadPlugins();
  updateProjectList();
}

// Логирование в консоль
function log(text) {
  const out = document.getElementById("output");
  out.textContent += text + "\n";
}

// Обновление списка проектов
function updateProjectList() {
  currentLang = document.getElementById("languageSelect").value;
}

// Создание проекта
function createProject() {
  const name = prompt("Имя проекта:");
  if (!name) return;
  const projects = JSON.parse(localStorage.getItem(`projects_${currentLang}`) || "[]");
  projects.push({ name, code: "" });
  localStorage.setItem(`projects_${currentLang}`, JSON.stringify(projects));
  log(`✅ Проект "${name}" создан`);
}

// Открытие проекта
function openProject(index) {
  const projects = JSON.parse(localStorage.getItem(`projects_${currentLang}`) || "[]");
  currentProject = index;
  document.getElementById("editor").textContent = projects[index].code;
}

// Сохранение проекта
function saveCurrentProject() {
  if (currentProject === null) return;
  const code = document.getElementById("editor").textContent;
  const projects = JSON.parse(localStorage.getItem(`projects_${currentLang}`) || "[]");
  projects[currentProject].code = code;
  localStorage.setItem(`projects_${currentLang}`, JSON.stringify(projects));
  log("✅ Проект сохранён");
}

// Запуск кода
async function runCode() {
  saveCurrentProject();
  const code = document.getElementById("editor").textContent;
  const lang = document.getElementById("languageSelect").value;

  document.getElementById("output").innerHTML = ""; // очистка предыдущего вывода

  if(lang === "python") {
    if(!pyodide) { log("❌ Pyodide не загружен"); return; }
    try {
      const result = await pyodide.runPythonAsync(code);
      log(result || "✅ Готово");
    } catch(e) {
      log("❌ Ошибка Python: " + e);
    }
  }
  else if(lang === "js") {
    try {
      const result = eval(code);
      log(result || "✅ Готово");
    } catch(e) {
      log("❌ Ошибка JS: " + e);
    }
  }
  else if(lang === "html") {
    const iframe = document.createElement("iframe");
    iframe.style.width="100%";
    iframe.style.height="200px";
    document.getElementById("output").appendChild(iframe);
    iframe.contentDocument.open();
    iframe.contentDocument.write(code);
    iframe.contentDocument.close();
    log("✅ HTML отображён");
  }
  else if(lang === "c") {
    log("⚠ C пока не поддерживается без WASM компилятора");
  }
  else {
    log("⚠ Язык пока не поддерживается");
  }
}

// Загрузка плагинов (заглушка)
function loadPlugins() {
  log("✅ Плагины загружены (добавляйте .py файлы через localStorage)");
}

// Запуск
main();
</script>

</body>
</html>
